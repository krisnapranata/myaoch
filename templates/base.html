{% load static %}
<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{% block title %}MyAoCH - Kesiapan Bandara{% endblock %}</title>


<!-- Bootstrap CSS (CDN) -->
<link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
<link rel="stylesheet" href="{% static 'fonts/bootstrap-icons/bootstrap-icons.min.css' %}">
<!-- Bootstrap Icons -->


<!-- App CSS -->
<link rel="stylesheet" href="{% static 'css/new_myaoch.css' %}">
<link rel="stylesheet" href="{% static 'css/navbar.css' %}">
<link rel="stylesheet" href="{% static 'css/new_mobile.css' %}">

<!-- Global Styles -->
<link rel="stylesheet" href="{% static 'css/base.css' %}">

<script src="{% static 'js/app.js' %}" defer></script>


{% block extra_css %}{% endblock %}
</head>
<body>


<div class="layout-wrapper">


<!-- Navbar -->
{% include 'includes/navbar.html' %}


<!-- Main content -->
<main class="layout-content container py-3">
{% block content %}{% endblock %}
</main>


<!-- Footer -->
{% include 'includes/footer.html' %}


<!-- Bottom navigation (mobile) -->
{% include 'includes/new_bottomnav.html' %}


</div>


<!-- JS: Bootstrap + ChartJS + app script -->
<script src="{% static 'js/bootstrap.bundle.min.js' %}" defer></script>
<script src="{% static 'js/new_myaoch.js' %}"></script>
{% block extra_js %}

<!-- ======================================== -->
<!--            NOTIFICATION JAVASCRIPT        -->
<!-- ======================================== -->

<script>
// =============================
// 1. CSRF Utility
// =============================
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== "") {
    const cookies = document.cookie.split(";");
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === name + "=") {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie("csrftoken");


// =============================
// 2. Fetch Notification Count
// =============================
async function fetchNotifCount() {
  try {
    const res = await fetch("/notifications/count/");
    if (!res.ok) return;

    const data = await res.json();
    const badge = document.getElementById("notifCount");

    const c = data.unread || 0;

    if (c > 0) {
      badge.innerText = c > 99 ? "99+" : c;
      badge.style.display = "inline-block";
    } else {
      badge.style.display = "none";
    }

  } catch (err) {
    console.error("Notif Count Error:", err);
  }
}


// =============================
// 3. Fetch Notification List
// =============================
async function fetchNotifList() {
  try {
    const res = await fetch("/notifications/list/?page=1");
    if (!res.ok) return;

    const data = await res.json();
    const list = document.getElementById("notifList");
    const empty = document.getElementById("notifEmpty");

    list.innerHTML = "";

    if (!data.results || data.results.length === 0) {
      empty.style.display = "block";
      return;
    }

    empty.style.display = "none";

    data.results.forEach((n) => {
      const item = document.createElement("a");
      item.href = n.link || "#";
      item.className =
        "dropdown-item d-flex align-items-start py-2 border-bottom";
      item.style.cursor = "pointer";

      item.innerHTML = `
        <div class="me-2 mt-1">
          ${n.is_read ? "" : '<div class="unread-dot"></div>'}
        </div>
        <div class="flex-grow-1">
          <div class="fw-semibold">${n.title}</div>
          <div class="small text-muted">${n.message}</div>
          <small class="text-muted">${n.created_at}</small>
        </div>
      `;

      item.addEventListener("click", async (e) => {
        e.preventDefault();

        await fetch("/notifications/mark-read/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken,
          },
          body: JSON.stringify({ id: n.id }),
        });

        if (n.link && n.link !== "#") {
          window.location.href = n.link;
        } else {
          fetchNotifCount();
          fetchNotifList();
        }
      });

      list.appendChild(item);
    });

  } catch (err) {
    console.error("Notif List Error:", err);
  }
}


// =============================
// 4. Mark All Read
// =============================
async function markAllRead() {
  try {
    await fetch("/notifications/mark-read/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken,
      },
      body: JSON.stringify({ id: "all" }),
    });

    fetchNotifCount();
    fetchNotifList();
  } catch (err) {
    console.error("Mark All Error:", err);
  }
}


// =============================
// 5. DOM Events
// =============================
document.addEventListener("DOMContentLoaded", () => {

  const markBtn = document.getElementById("markAllReadBtn");
  if (markBtn) {
    markBtn.addEventListener("click", () => markAllRead());
  }

  fetchNotifCount();
});

const notifBtn = document.getElementById("notifBtn");
if (notifBtn) {
  notifBtn.addEventListener("click", () => {
    setTimeout(fetchNotifList, 150);
  });
}

// auto polling
setInterval(fetchNotifCount, 20000);

</script>

{% endblock extra_js %}
</body>
</html>