{% extends "base.html" %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/operator.css' %}">
{% endblock %}

{% block title %}Dashboard Operator â€” MyAoCH{% endblock %}

{% block content %}


<!-- âœ… PAGE HEADER -->
<h1 class="page-title">ðŸ‘· Officer</h1>


<!-- âœ… FORM UTAMA (TIDAK ADA NESTED FORM) -->
<form id="formOperator" method="POST">
    {% csrf_token %}

    <!-- Hidden untuk save row -->
    <input type="hidden" id="rowSaveId" name="peralatan_id">
    <input type="hidden" id="rowSaveValue" name="jumlah_normal">

<div class="main-card">

    <!-- âœ… TOMBOL SIMPAN SEMUA -->
    <div class="header-tools">
    <h4 class="fw-bold mb-2">ðŸ“‹ Daftar Peralatan Hari Ini</h4>

    <button class="save-all-btn"
            type="submit"
            formaction="{% url 'operator_save_all' %}">
        ðŸ’¾ Simpan Semua
    </button>
</div>

<!-- âœ… TABLE -->
<div class="table-responsive-mobile">
<div class="table-wrapper">

    <div class="toolbar-row">
        <input type="text" id="searchInput" class="toolbar-search"
               placeholder="ðŸ” Cari peralatan...">
    </div>

    <div class="toolbar-buttons">
        <button id="btnDashboardUmum" class="tb-btn" formaction="{% url 'dashboard' %}">ðŸ“Š Dashboard</button>
        <button id="btnHistory" class="tb-btn">ðŸ•“ Riwayat</button>
    </div>
    

<table class="elegant-table">
<thead>
<tr>
    <th>Peralatan</th>
    <th class="center">Jumlah Normal</th>
    <th class="center">Nilai</th>
    <th class="center">Verifikasi</th>
    <th class="center">Aksi</th>
</tr>
</thead>

<tbody>
{% for p in peralatan_list %}
<tr>

<td class="nama-peralatan">{{ p.nama_peralatan }}</td>

<td class="center">
    <input type="number"
       name="jumlah_normal_{{ p.id }}"
       class="input-normal"
       value="{{ p.jumlah_normal_hari_ini }}"
       min="0" max="{{ p.jumlah_alat }}">
</td>

<td class="center">
    {% if p.nilai_hari_ini %}
    <span class="badge-blue">{{ p.nilai_hari_ini|floatformat:0 }}%</span>
{% else %}
    <span class="badge-grey">-</span>
{% endif %}
</td>

<td class="center">
    {% if p.status_verifikasi == "Draft" %}
        <span class="badge-green">Draft</span>
    {% elif p.status_verifikasi == "Diverifikasi SPV" %}
        <span class="badge-yellow">Verif SPV</span>
    {% elif p.status_verifikasi == "Diverifikasi AOCH" %}
        <span class="badge-green">Verif AOCH</span>
    {% elif p.status_verifikasi == "Butuh Verif GM" %}
        <span class="badge-gm">Verif GM</span>
    {% elif p.status_verifikasi == "Final" %}
        <span class="badge-green">Final</span>
    {% else %}
        <span class="badge-grey">-</span>
    {% endif %}
</td>

<td class="center">
    <button type="submit"
            class="btn-save-row"
            formaction="{% url 'operator_save_kesiapan' %}"
            data-id="{{ p.id }}">
        ðŸ’¾
    </button>
</td>

</tr>
{% endfor %}
</tbody>
</table>

</div>
</div>

</div>
</form>

{% endblock %}

{% block extra_js %}
<script>
/* âœ… SAVE BARIS */
document.querySelectorAll(".btn-save-row").forEach(btn => {
    btn.addEventListener("click", function () {
        const id = this.dataset.id;
        const row = this.closest("tr");
        const val = row.querySelector(".input-normal").value;

        document.getElementById("rowSaveId").value = id;
        document.getElementById("rowSaveValue").value = val;
    });
});

/* âœ… SEARCH FILTER */
document.getElementById('searchInput').addEventListener('input', function(){
    const filter = this.value.toLowerCase();
    document.querySelectorAll('tbody tr').forEach(tr => {
        tr.style.display = tr.textContent.toLowerCase().includes(filter) ? '' : 'none';
    });
});

/* âœ… NAVIGATION */
document.getElementById("btnDashboardUmum").onclick = () => window.location.href = "/dashboard/";
document.getElementById("btnHistory").onclick = () => window.location.href = "/operator/history/";
</script>
{% endblock %}
