{% extends "base.html" %}
{% load static %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/operator.css' %}">
{% endblock %}

{% block title %}Dashboard Operator â€” MyAoCH{% endblock %}

{% block content %}

<h1 class="page-title">ðŸ‘· Officer</h1>

<form id="formOperator" method="POST">
    {% csrf_token %}

    <!-- Hidden untuk save row -->
    <input type="hidden" id="rowSaveId" name="peralatan_id">
    <input type="hidden" id="rowSaveValue" name="jumlah_normal">

<div class="equipment-card">

    <!-- HEADER ROW -->
    <div class="header-row">
        <h4>ðŸ“‹ Daftar Peralatan</h4>

        <!-- Tombol Save All gaya konsumsi energi -->
        <button class="btn-add" type="submit" formaction="{% url 'operator_save_all' %}">
            ðŸ’¾ Simpan Semua
        </button>
    </div>


    <!-- SEARCH -->
    <div class="toolbar-row">
        <input type="text" id="searchInput" class="toolbar-search"
               placeholder="ðŸ” Cari peralatan...">
    </div>


    <!-- DESKTOP TABLE -->
    <div class="desktop-only">
        <table class="elegant-table">
            <thead>
                <tr>
                    <th>Peralatan</th>
                    <th class="center">Jumlah Normal</th>
                    <th class="center">Nilai</th>
                    <th class="center">Verifikasi</th>
                    <th class="center">Aksi</th>
                </tr>
            </thead>

            <tbody>
                {% for p in peralatan_list %}
                <tr>
                    <td class="nama-peralatan">{{ p.nama_peralatan }}</td>

                    <td class="center">
                        <input type="number"
                            name="jumlah_normal_{{ p.id }}"
                            class="input-normal"
                            value="{{ p.jumlah_normal_hari_ini }}"
                            min="0" max="{{ p.jumlah_alat }}">
                    </td>

                    <td class="center">
                    {% if p.nilai_hari_ini %}
                        <span class="badge-blue">{{ p.nilai_hari_ini|floatformat:0 }}%</span>
                    {% else %}
                        <span class="badge-grey">-</span>
                    {% endif %}
                    </td>

                    <td class="center">
                    {% if p.status_verifikasi == "Draft" %}
                        <span class="badge-green">Draft</span>
                    {% elif p.status_verifikasi == "Diverifikasi SPV" %}
                        <span class="badge-yellow">Verif SPV</span>
                    {% elif p.status_verifikasi == "Diverifikasi AOCH" %}
                        <span class="badge-green">Verif AOCH</span>
                    {% elif p.status_verifikasi == "Butuh Verif GM" %}
                        <span class="badge-gm">Verif GM</span>
                    {% elif p.status_verifikasi == "Final" %}
                        <span class="badge-green">Final</span>
                    {% else %}
                        <span class="badge-grey">-</span>
                    {% endif %}
                    </td>

                    <td class="center">
                        <button type="submit"
                                class="btn-save-row"
                                formaction="{% url 'operator_save_kesiapan' %}"
                                data-id="{{ p.id }}">
                            ðŸ’¾
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>


    <!-- MOBILE TABLE -->
    <div class="mobile-only mobile-table-wrapper">
        <table class="mobile-table">
            <thead>
                <tr>
                    <th>Peralatan</th>
                    <th>Normal</th>
                    <th>Nilai</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody>
                {% for p in peralatan_list %}
                <tr>
                    <td>{{ p.nama_peralatan }}</td>

                    <td>
                        <input type="number"
                               name="jumlah_normal_{{ p.id }}"
                               class="input-normal"
                               value="{{ p.jumlah_normal_hari_ini }}"
                               min="0"
                               max="{{ p.jumlah_alat }}">
                    </td>

                    <td>
                        {% if p.nilai_hari_ini %}
                            <span class="badge-blue">{{ p.nilai_hari_ini|floatformat:0 }}%</span>
                        {% else %}
                            <span class="badge-grey">-</span>
                        {% endif %}
                    </td>

                    <td>
                        <button type="submit"
                                class="btn-save-row"
                                formaction="{% url 'operator_save_kesiapan' %}"
                                data-id="{{ p.id }}">
                            ðŸ’¾
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div> <!-- equipment-card -->

</form>

{% endblock %}

{% block extra_js %}
 {{ block.super }}
<script>
/* SAVE PER BARIS */
document.querySelectorAll(".btn-save-row").forEach(btn => {
    btn.addEventListener("click", function () {
        const id = this.dataset.id;
        const row = this.closest("tr");
        const val = row.querySelector(".input-normal").value;

        document.getElementById("rowSaveId").value = id;
        document.getElementById("rowSaveValue").value = val;
    });
});

/* SEARCH */
document.getElementById('searchInput').addEventListener('input', function(){
    const key = this.value.toLowerCase();
    document.querySelectorAll('tbody tr').forEach(tr => {
        tr.style.display = tr.textContent.toLowerCase().includes(key) ? '' : 'none';
    });
});
</script>
{% endblock %}
